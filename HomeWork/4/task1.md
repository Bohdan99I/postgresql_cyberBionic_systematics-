# üß© –í–≤–µ–¥–µ–Ω–Ω—è –≤ —Ä–µ–ª—è—Ü—ñ–π–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö  
## PostgreSQL + Python  
### –õ–µ–∫—Ü—ñ—è 4: –Ü–Ω—à—ñ –æ–±‚Äô—î–∫—Ç–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó  

---

## 1. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è (VIEW)

### üîπ –©–æ —Ç–∞–∫–µ VIEW?
**VIEW** ‚Äî —Ü–µ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π SQL-–∑–∞–ø–∏—Ç, —è–∫–∏–π –ø–æ–≤–æ–¥–∏—Ç—å—Å—è —è–∫ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è.  
–ú–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –Ω–∞–¥ –Ω–µ—é `SELECT`, `JOIN`, —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é —Ç–æ—â–æ.  
–®–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ –º–∞–π–∂–µ –Ω–µ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ —Ä–µ–∞–ª—å–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å.

---

### üéØ –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ VIEW?
- **–ö–µ—à—É–≤–∞–Ω–Ω—è** —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ (–º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è).  
- **–°–ø—Ä–æ—Å—Ç–∏—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏** ‚Äî –æ—Ñ–æ—Ä–º–ª—é—é—á–∏ —ó—Ö —É –≤–∏–≥–ª—è–¥—ñ VIEW.  
- **–û–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É** ‚Äî –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å –ª–∏—à–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Å—Ç–æ–≤–ø—Ü—ñ –∞–±–æ —Ä—è–¥–∫–∏.  
- **–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö –¥–ª—è ORM** –∞–±–æ –æ–∫—Ä–µ–º–∏—Ö –≥—Ä—É–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

---

### üî∏ –¢–∏–ø–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—å
| –¢–∏–ø | –û–ø–∏—Å |
|------|------|
| **TEMP / TEMPORARY** | –¢–∏–º—á–∞—Å–æ–≤–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è, –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è –ø—ñ—Å–ª—è —Å–µ–∞–Ω—Å—É. |
| **RECURSIVE** | –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤. |
| **–û–Ω–æ–≤–ª—é–≤–∞–Ω–µ (updatable)** | –ú–æ–∂–µ –±—É—Ç–∏ –∑–º—ñ–Ω–µ–Ω–µ (INSERT, UPDATE, DELETE). |
| **–ú–∞—Ç–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–µ (materialized)** | –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Ç—É –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ —Ç–∞–±–ª–∏—Ü—è (–∫–µ—à). |

---

### üèóÔ∏è –°—Ç–≤–æ—Ä–µ–Ω–Ω—è VIEW
```sql
CREATE [ OR REPLACE ] [ TEMP | TEMPORARY ] [ RECURSIVE ] VIEW view_name AS query;
```

#### –ü—Ä–∏–∫–ª–∞–¥–∏:
1. **–ü—Ä–æ—Å—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è**
```sql
CREATE VIEW customer_orders AS 
SELECT order_id, customer_id, order_date 
FROM orders;
```

2. **–ó –∫—ñ–ª—å–∫–æ—Ö —Ç–∞–±–ª–∏—Ü—å**
```sql
CREATE VIEW customer_order_details AS 
SELECT o.order_id, o.customer_id, d.product_id, d.quantity 
FROM orders o
JOIN order_details d ON o.order_id = d.order_id;
```

3. **–ó –ø—ñ–¥–∑–∞–ø–∏—Ç–æ–º**
```sql
CREATE VIEW customer_order_total AS 
SELECT o.order_id, o.customer_id,
       (SELECT SUM(d.quantity * d.unit_price)
        FROM order_details d 
        WHERE o.order_id = d.order_id) AS order_total
FROM orders o;
```

---

### ‚öôÔ∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è VIEW
- **–ü–µ—Ä–µ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è:**
```sql
CREATE OR REPLACE VIEW view_name AS ...
```

- **–ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è:**
```sql
ALTER VIEW old_name RENAME TO new_name;
```

- **–í–∏–¥–∞–ª–µ–Ω–Ω—è:**
```sql
DROP VIEW [IF EXISTS] view_name;
```

---

### üß± –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ VIEW
VIEW –º–æ–∂–µ –±—É—Ç–∏ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞–Ω–∏–º**, —è–∫—â–æ:
- –í –∑–∞–ø–∏—Ç—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ª–∏—à–µ –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—é.  
- –í—ñ–¥—Å—É—Ç–Ω—ñ `DISTINCT`, `GROUP BY`, `HAVING`, `LIMIT`, `OFFSET`, `UNION`, `INTERSECT`, `EXCEPT`.  
- –°—Ç–æ–≤–ø—Ü—ñ –±–µ–∑ –∞–≥—Ä–µ–≥–∞—Ç—ñ–≤ —á–∏ –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤.

–°–∫–ª–∞–¥–Ω—ñ—à—ñ VIEW –º–æ–∂–Ω–∞ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ **—Ç—Ä–∏–≥–µ—Ä–∏ INSTEAD OF**.

---

## 2. –§—É–Ω–∫—Ü—ñ—ó –≤ PostgreSQL

### üîπ –©–æ —Ü–µ?
–§—É–Ω–∫—Ü—ñ—ó ‚Äî —Ü–µ **–æ–±‚Äô—î–∫—Ç–∏ –ë–î**, —è–∫—ñ:
- –ø—Ä–∏–π–º–∞—é—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç–∏;
- –≤–∏–∫–æ–Ω—É—é—Ç—å SQL-–æ–ø–µ—Ä–∞—Ü—ñ—ó;
- –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

---

### ‚ö° –ù–∞–≤—ñ—â–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –≤ –ë–î?
- –®–≤–∏–¥—à–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–∫–æ–¥ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –ë–î).  
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–∏–Ω—Ü–∏–ø—É **SRP** ‚Äî –ª–æ–≥—ñ–∫—É –¥–∞–Ω–∏—Ö —Ä–æ–∑–º—ñ—â–µ–Ω–æ –ø–æ—Ä—É—á —ñ–∑ —Å–∞–º–∏–º–∏ –¥–∞–Ω–∏–º–∏.  
- –°–ø—ñ–ª—å–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π —Ä—ñ–∑–Ω–∏–º–∏ –∫–ª—ñ—î–Ω—Ç–∞–º–∏.  
- –ó–º–µ–Ω—à–µ–Ω–Ω—è –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ—ñ–∫—É.  
- –ë–µ–∑–ø–µ–∫–∞ ‚Äî –º–æ–∂–Ω–∞ –æ–±–º–µ–∂–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ñ—É–Ω–∫—Ü—ñ–π.  
- –ú–æ–¥—É–ª—å–Ω—ñ—Å—Ç—å ‚Äî –ø–µ—Ä–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–æ–¥—É.

---

### üî∏ –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π
| –§—É–Ω–∫—Ü—ñ—è | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|----------|--------------|
| `AVG()`, `SUM()` | –°–µ—Ä–µ–¥–Ω—î, —Å—É–º–∞ |
| `COUNT()` | –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—è–¥–∫—ñ–≤ |
| `MAX()`, `MIN()` | –ú–∞–∫—Å./–º—ñ–Ω. –∑–Ω–∞—á–µ–Ω–Ω—è |
| `UPPER()`, `LOWER()` | –ó–º—ñ–Ω–∞ —Ä–µ–≥—ñ—Å—Ç—Ä—É |
| `SUBSTRING()`, `TRIM()` | –†–æ–±–æ—Ç–∞ –∑ —Ä—è–¥–∫–∞–º–∏ |
| `NOW()` | –ü–æ—Ç–æ—á–Ω–∞ –¥–∞—Ç–∞ —ñ —á–∞—Å |

üìñ [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è PostgreSQL ‚Äî —Ñ—É–Ω–∫—Ü—ñ—ó](https://postgrespro.ru/docs/postgresql/15/xfunc-internal)

---

### üß† –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π
```sql
CREATE [ OR REPLACE ] FUNCTION name(args)
RETURNS type AS $$
-- logic
$$ LANGUAGE SQL;
```

#### –ü—Ä–æ—Å—Ç–∏–π –ø—Ä–∏–∫–ª–∞–¥:
```sql
CREATE OR REPLACE FUNCTION order_count()
RETURNS INTEGER AS $$
    SELECT COUNT(*) FROM orders;
$$ LANGUAGE SQL;

SELECT order_count();
```

---

### üß© –§—É–Ω–∫—Ü—ñ—è-–∞–ø–¥–µ–π—Ç
```sql
CREATE OR REPLACE FUNCTION update_customer_fax()
RETURNS void AS $$
    UPDATE tmp_customers
    SET fax = 'do not use fax'
    WHERE fax IS NULL;
$$ LANGUAGE SQL;

SELECT update_customer_fax();
```

---

### üßÆ –§—É–Ω–∫—Ü—ñ—è –∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
```sql
CREATE OR REPLACE FUNCTION update_customer_fax(
    old_value varchar(24), 
    new_value varchar(24)
) RETURNS void AS $$
    UPDATE tmp_customers
    SET fax = new_value
    WHERE fax = old_value;
$$ LANGUAGE SQL;

SELECT update_customer_fax('do not use fax', 'no fax');
```

---

### üßæ –§—É–Ω–∫—Ü—ñ—è, —â–æ –ø–æ–≤–µ—Ä—Ç–∞—î —Ç–∞–±–ª–∏—Ü—é
```sql
CREATE OR REPLACE FUNCTION SalesResultsByMonth(year_in INT, month_in INT)
RETURNS TABLE (employee_id int2, first_name varchar(10), last_name varchar(20), total_sales real)
AS $$
SELECT e.employee_id, e.first_name, e.last_name,
       SUM(c.order_total) AS total_sales
FROM employees e
JOIN orders o ON e.employee_id = o.employee_id
JOIN customer_order_total c ON c.order_id = o.order_id
WHERE make_date(year_in, month_in, 1) <= o.order_date
  AND o.order_date < make_date(year_in, month_in, 1) + interval '1 month'
GROUP BY e.employee_id, e.first_name, e.last_name
ORDER BY total_sales DESC;
$$ LANGUAGE SQL;
```

–í–∏–∫–ª–∏–∫:
```sql
SELECT * FROM SalesResultsByMonth(1997, 5);
```

---

## 3. –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–æ–≤–∏ PostgreSQL

PostgreSQL –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä—ñ–∑–Ω—ñ –º–æ–≤–∏ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π:

| –ú–æ–≤–∞ | –û–ø–∏—Å |
|------|------|
| **SQL** | –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞ –º–æ–≤–∞ –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ |
| **PL/pgSQL** | –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞ –º–æ–≤–∞ PostgreSQL |
| **PL/Python**, **PL/Tcl**, **PL/Perl** | –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑—ñ —Å–∫—Ä–∏–ø—Ç–æ–≤–∏–º–∏ –º–æ–≤–∞–º–∏ |
| **C** | –ú–æ–≤–∞ –Ω–∏–∂—á–æ–≥–æ —Ä—ñ–≤–Ω—è –¥–ª—è –≤–∏—Å–æ–∫–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ |

> üí° PL/pgSQL ‚Äî –æ—Å–Ω–æ–≤–Ω–∞ –º–æ–≤–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä —É PostgreSQL, —à–≤–∏–¥–∫–∞ —Ç–∞ –±–µ–∑–ø–µ—á–Ω–∞.  
> –ü—Ä–æ—Ç–µ —É –¥–µ—è–∫–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö PL/Python –º–æ–∂–µ –±—É—Ç–∏ –Ω–∞–≤—ñ—Ç—å —à–≤–∏–¥—à–æ—é.
